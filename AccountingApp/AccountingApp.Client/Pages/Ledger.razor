@page "/ledger"
@using AccountingApp.Shared.Models
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav

<h3>Account Ledger</h3>

<div class="row mb-3">
    <div class="col-md-6">
        <label>Select Account:</label>
        <select class="form-select" @onchange="LoadAccountLedger">
            <option value="0">-- Select --</option>
            @foreach (var acc in accounts)
            {
                <option value="@acc.Id">@acc.Name (@acc.Type)</option>
            }
        </select>
    </div>
</div>

@if (ledgerItems == null && selectedAccountId > 0)
{
    <p><em>Loading...</em></p>
}
else if (ledgerItems != null && ledgerItems.Count == 0)
{
    <div class="alert alert-warning">No transactions found for this account.</div>
}
else if (ledgerItems != null)
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Date</th>
                <th>Description</th>
                <th class="text-end">Debit</th>
                <th class="text-end">Credit</th>
                <th class="text-end">Balance</th>
                <th class="text-center">Actions</th> <!-- NEW HEADER -->
            </tr>
        </thead>
        <tbody>
            @{
                decimal runningBalance = 0;
            }
            @foreach (var item in ledgerItems)
            {
                // Calculate Running Balance
                // Note: For Assets/Expenses, Debit increases balance.
                // For Liab/Equity/Income, Credit increases balance.
                // Here is a simple "Debit is positive" approach:
                runningBalance += (item.Debit - item.Credit);

                <tr>
                    <td>@item.Date.ToShortDateString()</td>
                    <td>
                        <a href="javascript:void(0)">#@item.JournalEntryId</a>
                        @item.Description
                    </td>
                    <!-- NEW: Attachments Column -->
                    <td>
                        @foreach (var att in item.Attachments)
                        {
                            <div class="mb-1">
                                @if (IsImage(att.ContentType))
                                {
                                    <!-- Render Image directly -->
                                    <div style="max-width: 100px;">
                                        <a href="api/Attachments/@att.Id" target="_blank">
                                            <img src="api/Attachments/@att.Id"
                                                 class="img-thumbnail"
                                                 style="max-height: 50px;"
                                                 alt="@att.FileName" />
                                        </a>
                                    </div>
                                }
                                else
                                {
                                    <!-- Render Generic Download Link -->
                                    <a href="api/Attachments/@att.Id" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        📄 @att.FileName
                                    </a>
                                }
                            </div>
                        }
                    </td>
                    <!-- ------------------------ -->
                    <td class="text-end">
                        @(item.Debit != 0 ? item.Debit.ToString("N2") : "-")
                    </td>
                    <td class="text-end">
                        @(item.Credit != 0 ? item.Credit.ToString("N2") : "-")
                    </td>
                    <td class="text-end fw-bold @GetColor(runningBalance)">
                        @runningBalance.ToString("N2")
                    </td>
                       <!-- NEW ACTIONS COLUMN -->
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" 
                                @onclick="@( () => Nav.NavigateTo($"/entry/edit/{item.JournalEntryId}"))"
                                title="Edit Entry">
                            <span class="bi bi-pencil"></span>
                        </button>
                        
                        <button class="btn btn-sm btn-outline-danger ms-1" 
                                @onclick="() => DeleteEntry(item.JournalEntryId)"
                                title="Delete Entry">
                            <span class="bi bi-trash"></span>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Account> accounts = new();
    private List<LedgerItem>? ledgerItems;
    private int selectedAccountId = 0;

    protected override async Task OnInitializedAsync()
    {
        // Load the list of accounts for the dropdown
        accounts = await Http.GetFromJsonAsync<List<Account>>("api/JournalEntries/accounts") ?? new();
    }

    private async Task LoadAccountLedger(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int accId) && accId > 0)
        {
            selectedAccountId = accId;
            ledgerItems = null; // Show loading state
            ledgerItems = await Http.GetFromJsonAsync<List<LedgerItem>>($"api/JournalEntries/ledger/{accId}");
        }
        else
        {
            selectedAccountId = 0;
            ledgerItems = null;
        }
    }

    private string GetColor(decimal balance)
    {
        // Simple visual styling: Negative numbers red, Positive green (optional)
        return balance < 0 ? "text-danger" : "text-success";
    }

    private bool IsImage(string contentType)
    {
        return contentType.Contains("image", StringComparison.OrdinalIgnoreCase);
    }

    private async Task DeleteEntry(int entryId)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this journal entry? This cannot be undone.");

        if (confirmed)
        {
            var response = await Http.DeleteAsync($"api/JournalEntries/{entryId}");

            if (response.IsSuccessStatusCode)
            {
                // Refresh the grid
                // We need to call LoadAccountLedger again manually,
                // but since that event needs ChangeEventArgs, let's just refactor the loading logic slightly
                // or simply reload the list directly:
                ledgerItems = await Http.GetFromJsonAsync<List<LedgerItem>>($"api/JournalEntries/ledger/{selectedAccountId}");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Error deleting entry.");
            }
        }
    }
}